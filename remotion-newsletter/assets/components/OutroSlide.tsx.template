/**
 * OutroSlide Component Template
 *
 * Memorable closing sequence with sources, CTA, and signature animation.
 * Duration: 90 frames (3 seconds at 30fps)
 *
 * Animation Sequence:
 * 0-25:   Background particles emerge
 * 5-35:   Main message reveal (word cascade)
 * 30-50:  Accent line animation
 * 40-65:  Sources fade in (staggered)
 * 55-75:  CTA button scale pop
 * 75-90:  Hold and gentle pulse
 */

import React, { useState, useMemo } from "react";
import {
  AbsoluteFill,
  interpolate,
  useCurrentFrame,
  useVideoConfig,
  random,
} from "remotion";

// ═══════════════════════════════════════════════════════════════
// GSAP-INSPIRED EASING FUNCTIONS
// ═══════════════════════════════════════════════════════════════

const easeOutExpo = (t: number): number =>
  t === 1 ? 1 : 1 - Math.pow(2, -10 * t);

const easeOutCubic = (t: number): number => 1 - Math.pow(1 - t, 3);

const easeOutBack = (t: number): number => {
  const c1 = 1.70158;
  const c3 = c1 + 1;
  return 1 + c3 * Math.pow(t - 1, 3) + c1 * Math.pow(t - 1, 2);
};

const easeInCubic = (t: number): number => t * t * t;

// ═══════════════════════════════════════════════════════════════
// TYPES
// ═══════════════════════════════════════════════════════════════

interface Source {
  name: string;
  url?: string;
}

interface OutroSlideProps {
  sources?: Source[];
  outroText?: string;
  ctaText?: string;
  ctaSubtext?: string;
  logo?: React.ReactNode;
  primaryColor?: string;
  secondaryColor?: string;
  backgroundColor?: string;
}

// ═══════════════════════════════════════════════════════════════
// SUB-COMPONENTS
// ═══════════════════════════════════════════════════════════════

/** Floating particles background */
const ParticleField: React.FC<{
  primaryColor: string;
  secondaryColor: string;
}> = ({ primaryColor, secondaryColor }) => {
  const frame = useCurrentFrame();
  const { width, height } = useVideoConfig();

  const particles = useMemo(() => {
    return Array.from({ length: 40 }, (_, i) => ({
      x: random(`out-px-${i}`) * width,
      y: random(`out-py-${i}`) * height,
      size: 2 + random(`out-ps-${i}`) * 4,
      speed: 0.3 + random(`out-psp-${i}`) * 0.7,
      color: random(`out-pc-${i}`) > 0.5 ? primaryColor : secondaryColor,
      opacity: 0.1 + random(`out-po-${i}`) * 0.4,
      delay: random(`out-pd-${i}`) * 30,
    }));
  }, [width, height, primaryColor, secondaryColor]);

  return (
    <AbsoluteFill style={{ overflow: "hidden", pointerEvents: "none" }}>
      {particles.map((particle, i) => {
        // Delayed appearance
        const appearProgress = Math.min(Math.max(0, frame - particle.delay) / 20, 1);
        const appearEased = easeOutCubic(appearProgress);

        // Gentle float
        const yOffset = ((frame + particle.delay) * particle.speed * 0.5) % 50;
        const xDrift = Math.sin((frame + i * 10) * 0.02) * 15;

        return (
          <div
            key={i}
            style={{
              position: "absolute",
              left: particle.x + xDrift,
              top: particle.y - yOffset,
              width: particle.size,
              height: particle.size,
              borderRadius: "50%",
              backgroundColor: particle.color,
              opacity: particle.opacity * appearEased,
              boxShadow: `0 0 ${particle.size * 3}px ${particle.color}40`,
            }}
          />
        );
      })}
    </AbsoluteFill>
  );
};

/** Animated word cascade for main message */
const WordCascade: React.FC<{
  text: string;
  startFrame: number;
  color: string;
  glowColor: string;
  fontSize?: number;
}> = ({ text, startFrame, color, glowColor, fontSize = 72 }) => {
  const frame = useCurrentFrame();
  const words = text.split(" ");

  return (
    <h1
      style={{
        fontSize,
        fontFamily: '"Playfair Display", Georgia, serif',
        fontWeight: 700,
        color,
        margin: 0,
        textAlign: "center",
        lineHeight: 1.2,
      }}
    >
      {words.map((word, i) => {
        const delay = startFrame + i * 5;
        const animationStart = Math.max(0, frame - delay);
        const progress = Math.min(animationStart / 20, 1);
        const eased = easeOutExpo(progress);

        const glowIntensity = eased * 0.6;

        return (
          <span
            key={i}
            style={{
              display: "inline-block",
              marginRight: "0.25em",
              opacity: eased,
              transform: `translateY(${(1 - eased) * 40}px) scale(${0.9 + eased * 0.1})`,
              filter: `blur(${(1 - eased) * 5}px)`,
              textShadow: `
                0 0 ${20 * glowIntensity}px ${glowColor}50,
                0 0 ${40 * glowIntensity}px ${glowColor}30
              `,
            }}
          >
            {word}
          </span>
        );
      })}
    </h1>
  );
};

/** Animated accent line */
const AccentLine: React.FC<{
  startFrame: number;
  primaryColor: string;
  secondaryColor: string;
}> = ({ startFrame, primaryColor, secondaryColor }) => {
  const frame = useCurrentFrame();
  const [gradientId] = useState(() => `outro-line-${random(null)}`);

  const animationStart = Math.max(0, frame - startFrame);
  const progress = Math.min(animationStart / 20, 1);
  const eased = easeOutExpo(progress);

  const lineWidth = eased * 200;

  // Shimmer effect after line is drawn
  const shimmer = progress === 1 ? Math.sin((frame - startFrame - 20) * 0.15) * 0.3 : 0;

  return (
    <div
      style={{
        display: "flex",
        justifyContent: "center",
        marginTop: 30,
        marginBottom: 40,
      }}
    >
      <svg width={220} height={6} style={{ overflow: "visible" }}>
        <defs>
          <linearGradient id={gradientId} x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stopColor={primaryColor} />
            <stop offset="50%" stopColor={secondaryColor} />
            <stop offset="100%" stopColor={primaryColor} />
          </linearGradient>
        </defs>
        <rect
          x={(220 - lineWidth) / 2}
          y={1}
          width={lineWidth}
          height={4}
          rx={2}
          fill={`url(#${gradientId})`}
          style={{
            filter: `drop-shadow(0 0 ${8 + shimmer * 10}px ${primaryColor}80)`,
          }}
        />
      </svg>
    </div>
  );
};

/** Source pill with staggered fade */
const SourcePill: React.FC<{
  source: Source;
  index: number;
  startFrame: number;
  primaryColor: string;
}> = ({ source, index, startFrame, primaryColor }) => {
  const frame = useCurrentFrame();

  const delay = startFrame + index * 6;
  const animationStart = Math.max(0, frame - delay);
  const progress = Math.min(animationStart / 15, 1);
  const eased = easeOutBack(progress);

  return (
    <div
      style={{
        backgroundColor: "rgba(255,255,255,0.05)",
        padding: "10px 20px",
        borderRadius: 25,
        border: "1px solid rgba(255,255,255,0.1)",
        opacity: eased,
        transform: `scale(${0.8 + eased * 0.2}) translateY(${(1 - eased) * 10}px)`,
      }}
    >
      <span
        style={{
          fontFamily: '"DM Sans", sans-serif',
          fontSize: 16,
          color: "#E4E4E7",
          fontWeight: 500,
        }}
      >
        {source.name}
      </span>
    </div>
  );
};

/** CTA button with pop animation */
const CTAButton: React.FC<{
  text: string;
  subtext?: string;
  startFrame: number;
  primaryColor: string;
  secondaryColor: string;
}> = ({ text, subtext, startFrame, primaryColor, secondaryColor }) => {
  const frame = useCurrentFrame();
  const [gradientId] = useState(() => `cta-${random(null)}`);

  const animationStart = Math.max(0, frame - startFrame);
  const progress = Math.min(animationStart / 25, 1);
  const eased = easeOutBack(progress);

  // Subtle pulse after appearing
  const settled = progress === 1;
  const pulse = settled ? 1 + Math.sin((frame - startFrame - 25) * 0.1) * 0.02 : eased;

  // Glow intensity increases after settling
  const glowIntensity = settled ? 0.8 + Math.sin((frame - startFrame - 25) * 0.08) * 0.2 : eased * 0.6;

  return (
    <div
      style={{
        display: "flex",
        flexDirection: "column",
        alignItems: "center",
        marginTop: 40,
        opacity: eased,
        transform: `scale(${pulse * (0.8 + eased * 0.2)})`,
      }}
    >
      <div
        style={{
          position: "relative",
          padding: "18px 50px",
          borderRadius: 35,
          overflow: "hidden",
        }}
      >
        {/* Gradient background */}
        <svg
          style={{
            position: "absolute",
            inset: 0,
            width: "100%",
            height: "100%",
          }}
        >
          <defs>
            <linearGradient id={gradientId} x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stopColor={primaryColor} />
              <stop offset="100%" stopColor={secondaryColor} />
            </linearGradient>
          </defs>
          <rect
            fill={`url(#${gradientId})`}
            width="100%"
            height="100%"
            rx={35}
          />
        </svg>

        {/* Glow layer */}
        <div
          style={{
            position: "absolute",
            inset: -10,
            background: `radial-gradient(ellipse at center, ${primaryColor}${Math.round(glowIntensity * 0.4 * 255).toString(16).padStart(2, '0')} 0%, transparent 70%)`,
            filter: "blur(15px)",
            zIndex: -1,
          }}
        />

        {/* Text */}
        <span
          style={{
            position: "relative",
            fontFamily: '"DM Sans", sans-serif',
            fontSize: 22,
            fontWeight: 700,
            color: "#FFFFFF",
            letterSpacing: 1,
          }}
        >
          {text}
        </span>
      </div>

      {/* Subtext */}
      {subtext && (
        <p
          style={{
            fontFamily: '"DM Sans", sans-serif',
            fontSize: 14,
            color: "#A1A1AA",
            marginTop: 12,
            opacity: eased,
          }}
        >
          {subtext}
        </p>
      )}
    </div>
  );
};

/** Vignette overlay */
const Vignette: React.FC = () => (
  <AbsoluteFill
    style={{
      background: `radial-gradient(ellipse at center,
        transparent 30%,
        rgba(0,0,0,0.3) 70%,
        rgba(0,0,0,0.6) 100%
      )`,
      pointerEvents: "none",
    }}
  />
);

// ═══════════════════════════════════════════════════════════════
// MAIN COMPONENT
// ═══════════════════════════════════════════════════════════════

export const OutroSlide: React.FC<OutroSlideProps> = ({
  sources = [],
  outroText = "Thanks for watching",
  ctaText,
  ctaSubtext,
  logo,
  primaryColor = "#6366F1",
  secondaryColor = "#8B5CF6",
  backgroundColor = "#0A0A0F",
}) => {
  const frame = useCurrentFrame();
  const { durationInFrames } = useVideoConfig();

  // Exit fade
  const exitStart = durationInFrames - 15;
  const exitProgress = Math.max(0, frame - exitStart) / 12;
  const globalOpacity = 1 - easeInCubic(Math.min(exitProgress, 1));

  // Ambient glow animation
  const glowPulse = 0.15 + Math.sin(frame * 0.05) * 0.05;

  return (
    <AbsoluteFill style={{ backgroundColor }}>
      {/* Layer 1: Particle field */}
      <ParticleField primaryColor={primaryColor} secondaryColor={secondaryColor} />

      {/* Layer 2: Ambient glow */}
      <AbsoluteFill
        style={{
          background: `radial-gradient(ellipse at 50% 40%,
            ${primaryColor}${Math.round(glowPulse * 255).toString(16).padStart(2, '0')} 0%,
            transparent 60%
          )`,
          pointerEvents: "none",
        }}
      />

      {/* Layer 3: Content */}
      <AbsoluteFill
        style={{
          display: "flex",
          flexDirection: "column",
          justifyContent: "center",
          alignItems: "center",
          padding: 80,
          opacity: globalOpacity,
        }}
      >
        {/* Logo (if provided) */}
        {logo && (
          <div
            style={{
              marginBottom: 30,
              opacity: Math.min(frame / 15, 1),
            }}
          >
            {logo}
          </div>
        )}

        {/* Main message */}
        <WordCascade
          text={outroText}
          startFrame={5}
          color="#FFFFFF"
          glowColor={primaryColor}
          fontSize={72}
        />

        {/* Accent line */}
        <AccentLine
          startFrame={30}
          primaryColor={primaryColor}
          secondaryColor={secondaryColor}
        />

        {/* Sources section */}
        {sources.length > 0 && (
          <div style={{ marginBottom: 20 }}>
            <p
              style={{
                fontFamily: '"DM Sans", sans-serif',
                fontSize: 14,
                color: primaryColor,
                textAlign: "center",
                margin: 0,
                marginBottom: 15,
                letterSpacing: 3,
                textTransform: "uppercase",
                opacity: Math.min(Math.max(0, frame - 35) / 15, 1),
              }}
            >
              Sources
            </p>
            <div
              style={{
                display: "flex",
                flexWrap: "wrap",
                justifyContent: "center",
                gap: 12,
                maxWidth: 900,
              }}
            >
              {sources.slice(0, 6).map((source, i) => (
                <SourcePill
                  key={i}
                  source={source}
                  index={i}
                  startFrame={40}
                  primaryColor={primaryColor}
                />
              ))}
            </div>
          </div>
        )}

        {/* CTA button */}
        {ctaText && (
          <CTAButton
            text={ctaText}
            subtext={ctaSubtext}
            startFrame={55}
            primaryColor={primaryColor}
            secondaryColor={secondaryColor}
          />
        )}
      </AbsoluteFill>

      {/* Layer 4: Vignette */}
      <Vignette />

      {/* Layer 5: Bottom accent bar */}
      <div
        style={{
          position: "absolute",
          bottom: 0,
          left: 0,
          right: 0,
          height: 6,
          background: `linear-gradient(90deg, ${primaryColor}, ${secondaryColor}, ${primaryColor})`,
          opacity: Math.min(frame / 20, 1) * globalOpacity,
        }}
      />
    </AbsoluteFill>
  );
};

export default OutroSlide;
