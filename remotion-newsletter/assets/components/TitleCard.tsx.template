/**
 * TitleCard Component Template
 *
 * Cinematic title reveal with layered animations, glow effects, and
 * GSAP-inspired easing. Duration: 90 frames (3 seconds at 30fps)
 *
 * Animation Sequence:
 * 0-20:   Background fade + mesh gradient motion
 * 5-35:   Title words cascade with scale + blur
 * 35-55:  Subtitle mask reveal
 * 45-65:  Accent line wipe
 * 50-70:  Decorative elements fade
 *
 * TEMPLATE VARIABLES:
 * - {{STYLE}}: cinematic-dark | editorial-bold | broadcast-news | social-native
 */

import React, { useState, useMemo } from "react";
import {
  AbsoluteFill,
  interpolate,
  useCurrentFrame,
  useVideoConfig,
  random,
} from "remotion";

// ═══════════════════════════════════════════════════════════════
// GSAP-INSPIRED EASING FUNCTIONS
// ═══════════════════════════════════════════════════════════════

const easeOutExpo = (t: number): number =>
  t === 1 ? 1 : 1 - Math.pow(2, -10 * t);

const easeOutCubic = (t: number): number => 1 - Math.pow(1 - t, 3);

const easeOutBack = (t: number): number => {
  const c1 = 1.70158;
  const c3 = c1 + 1;
  return 1 + c3 * Math.pow(t - 1, 3) + c1 * Math.pow(t - 1, 2);
};

const easeInOutCubic = (t: number): number =>
  t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;

// ═══════════════════════════════════════════════════════════════
// COMPONENT TYPES
// ═══════════════════════════════════════════════════════════════

interface TitleCardProps {
  topic: string;
  subtitle?: string;
  date?: string;
  style?: "cinematic-dark" | "editorial-bold" | "broadcast-news" | "social-native";
  primaryColor?: string;
  secondaryColor?: string;
  accentColor?: string;
  backgroundColor?: string;
}

// ═══════════════════════════════════════════════════════════════
// STYLE PRESETS
// ═══════════════════════════════════════════════════════════════

const stylePresets = {
  "cinematic-dark": {
    fontDisplay: '"Playfair Display", Georgia, serif',
    fontBody: '"DM Sans", "Helvetica Neue", sans-serif',
    bg: "#0A0A0F",
    bgElevated: "#12121A",
    text: "#FFFFFF",
    textMuted: "#A1A1AA",
    primary: "#6366F1",
    secondary: "#8B5CF6",
    glow: "#818CF8",
  },
  "editorial-bold": {
    fontDisplay: '"Bebas Neue", "Anton", sans-serif',
    fontBody: '"Source Sans 3", sans-serif',
    bg: "#000000",
    bgElevated: "#141414",
    text: "#FFFFFF",
    textMuted: "#A3A3A3",
    primary: "#EF4444",
    secondary: "#F87171",
    glow: "#FCA5A5",
  },
  "broadcast-news": {
    fontDisplay: '"Inter", "Roboto", sans-serif',
    fontBody: '"Inter", sans-serif',
    bg: "#0F172A",
    bgElevated: "#1E293B",
    text: "#F8FAFC",
    textMuted: "#94A3B8",
    primary: "#0EA5E9",
    secondary: "#38BDF8",
    glow: "#7DD3FC",
  },
  "social-native": {
    fontDisplay: '"Clash Display", "Urbanist", sans-serif',
    fontBody: '"Plus Jakarta Sans", sans-serif',
    bg: "#0D0D1A",
    bgElevated: "#1A1A35",
    text: "#FFFFFF",
    textMuted: "#9090C0",
    primary: "#F43F5E",
    secondary: "#06B6D4",
    glow: "#FB7185",
  },
};

// ═══════════════════════════════════════════════════════════════
// SUB-COMPONENTS
// ═══════════════════════════════════════════════════════════════

/** Animated mesh gradient background */
const MeshBackground: React.FC<{
  colors: string[];
  backgroundColor: string;
}> = ({ colors, backgroundColor }) => {
  const frame = useCurrentFrame();

  // Subtle organic movement
  const offset1 = Math.sin(frame * 0.03) * 8;
  const offset2 = Math.cos(frame * 0.025) * 8;
  const offset3 = Math.sin(frame * 0.02 + 1) * 6;

  // Fade in background
  const bgProgress = Math.min(frame / 20, 1);
  const bgOpacity = easeOutCubic(bgProgress);

  return (
    <AbsoluteFill
      style={{
        opacity: bgOpacity,
        background: `
          radial-gradient(ellipse at ${35 + offset1}% ${30 + offset2}%, ${colors[0]}50 0%, transparent 50%),
          radial-gradient(ellipse at ${65 - offset1}% ${25 + offset3}%, ${colors[1]}40 0%, transparent 45%),
          radial-gradient(ellipse at ${25 + offset2}% ${70 - offset1}%, ${colors[0]}30 0%, transparent 55%),
          radial-gradient(ellipse at ${75 - offset3}% ${75 - offset2}%, ${colors[1]}35 0%, transparent 50%),
          ${backgroundColor}
        `,
      }}
    />
  );
};

/** Vignette overlay for cinematic depth */
const Vignette: React.FC<{ intensity?: number }> = ({ intensity = 0.6 }) => (
  <AbsoluteFill
    style={{
      background: `radial-gradient(ellipse at center,
        transparent 20%,
        rgba(0,0,0,${intensity * 0.3}) 60%,
        rgba(0,0,0,${intensity * 0.7}) 100%
      )`,
      pointerEvents: "none",
    }}
  />
);

/** Word with individual animation */
const AnimatedWord: React.FC<{
  word: string;
  index: number;
  fontFamily: string;
  color: string;
  glowColor: string;
}> = ({ word, index, fontFamily, color, glowColor }) => {
  const frame = useCurrentFrame();

  // Staggered start: 5 frames per word, starting at frame 8
  const delay = 8 + index * 5;
  const animationDuration = 25;
  const animationStart = Math.max(0, frame - delay);
  const progress = Math.min(animationStart / animationDuration, 1);

  // Apply dramatic easing
  const eased = easeOutExpo(progress);

  // Transform values
  const opacity = eased;
  const translateY = (1 - eased) * 60;
  const scale = 0.85 + eased * 0.15;
  const blur = (1 - eased) * 8;

  // Glow intensifies as word settles
  const glowIntensity = eased * 0.5;

  return (
    <span
      style={{
        display: "inline-block",
        marginRight: "0.25em",
        opacity,
        transform: `translateY(${translateY}px) scale(${scale})`,
        filter: `blur(${blur}px)`,
        textShadow: `0 0 ${30 * glowIntensity}px ${glowColor}60,
                     0 0 ${60 * glowIntensity}px ${glowColor}30`,
        fontFamily,
        fontWeight: 700,
      }}
    >
      {word}
    </span>
  );
};

/** Subtitle with mask reveal effect */
const MaskRevealText: React.FC<{
  text: string;
  startFrame: number;
  fontFamily: string;
  color: string;
}> = ({ text, startFrame, fontFamily, color }) => {
  const frame = useCurrentFrame();

  const animationStart = Math.max(0, frame - startFrame);
  const progress = Math.min(animationStart / 25, 1);
  const eased = easeOutCubic(progress);

  return (
    <div style={{ overflow: "hidden", display: "inline-block" }}>
      <p
        style={{
          fontFamily,
          fontSize: 36,
          fontWeight: 500,
          color,
          margin: 0,
          transform: `translateY(${(1 - eased) * 100}%)`,
          opacity: eased,
          letterSpacing: 1,
        }}
      >
        {text}
      </p>
    </div>
  );
};

/** Animated accent line */
const AccentLine: React.FC<{
  startFrame: number;
  primaryColor: string;
  secondaryColor: string;
}> = ({ startFrame, primaryColor, secondaryColor }) => {
  const frame = useCurrentFrame();
  const { width } = useVideoConfig();
  const [gradientId] = useState(() => `line-${random(null)}`);

  const animationStart = Math.max(0, frame - startFrame);
  const progress = Math.min(animationStart / 20, 1);
  const eased = easeOutExpo(progress);

  const lineWidth = eased * 250;

  return (
    <svg
      width={300}
      height={6}
      style={{ marginTop: 40, overflow: "visible" }}
    >
      <defs>
        <linearGradient id={gradientId} x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stopColor={primaryColor} />
          <stop offset="100%" stopColor={secondaryColor} />
        </linearGradient>
      </defs>
      <rect
        x={(300 - lineWidth) / 2}
        y={0}
        width={lineWidth}
        height={4}
        rx={2}
        fill={`url(#${gradientId})`}
        style={{
          filter: `drop-shadow(0 0 10px ${primaryColor}80)`,
        }}
      />
    </svg>
  );
};

// ═══════════════════════════════════════════════════════════════
// MAIN COMPONENT
// ═══════════════════════════════════════════════════════════════

export const TitleCard: React.FC<TitleCardProps> = ({
  topic,
  subtitle,
  date,
  style = "cinematic-dark",
  primaryColor,
  secondaryColor,
  accentColor,
  backgroundColor,
}) => {
  const frame = useCurrentFrame();
  const { durationInFrames } = useVideoConfig();

  // Get style preset
  const preset = stylePresets[style];

  // Allow color overrides
  const colors = {
    primary: primaryColor || preset.primary,
    secondary: secondaryColor || preset.secondary,
    glow: accentColor || preset.glow,
    bg: backgroundColor || preset.bg,
    bgElevated: preset.bgElevated,
    text: preset.text,
    textMuted: preset.textMuted,
    fontDisplay: preset.fontDisplay,
    fontBody: preset.fontBody,
  };

  // Split title into words
  const words = topic.split(" ");

  // Global fade out at end
  const fadeOutStart = durationInFrames - 20;
  const fadeOutProgress = Math.max(0, frame - fadeOutStart) / 15;
  const globalOpacity = 1 - easeInOutCubic(Math.min(fadeOutProgress, 1));

  // Date fade in (late in sequence)
  const dateProgress = Math.min(Math.max(0, frame - 55) / 20, 1);
  const dateOpacity = easeOutCubic(dateProgress) * 0.6;

  return (
    <AbsoluteFill style={{ backgroundColor: colors.bg }}>
      {/* Layer 1: Animated mesh gradient background */}
      <MeshBackground
        colors={[colors.primary, colors.secondary]}
        backgroundColor={colors.bg}
      />

      {/* Layer 2: Vignette for depth */}
      <Vignette intensity={0.5} />

      {/* Layer 3: Content */}
      <AbsoluteFill
        style={{
          opacity: globalOpacity,
          display: "flex",
          flexDirection: "column",
          justifyContent: "center",
          alignItems: "center",
          padding: 100,
        }}
      >
        {/* Main Title - Word by Word */}
        <h1
          style={{
            fontSize: style === "editorial-bold" ? 100 : 90,
            textAlign: "center",
            color: colors.text,
            margin: 0,
            lineHeight: 1.1,
            maxWidth: 1400,
            textTransform: style === "editorial-bold" ? "uppercase" : "none",
          }}
        >
          {words.map((word, i) => (
            <AnimatedWord
              key={i}
              word={word}
              index={i}
              fontFamily={colors.fontDisplay}
              color={colors.text}
              glowColor={colors.glow}
            />
          ))}
        </h1>

        {/* Subtitle - Mask Reveal */}
        {subtitle && (
          <div style={{ marginTop: 30 }}>
            <MaskRevealText
              text={subtitle}
              startFrame={35}
              fontFamily={colors.fontBody}
              color={colors.secondary}
            />
          </div>
        )}

        {/* Accent Line */}
        <AccentLine
          startFrame={45}
          primaryColor={colors.primary}
          secondaryColor={colors.secondary}
        />

        {/* Date */}
        {date && (
          <p
            style={{
              fontFamily: colors.fontBody,
              fontSize: 20,
              color: colors.textMuted,
              marginTop: 30,
              opacity: dateOpacity,
              letterSpacing: 2,
              textTransform: "uppercase",
            }}
          >
            {date}
          </p>
        )}
      </AbsoluteFill>

      {/* Layer 4: Ambient glow pulse */}
      <AbsoluteFill
        style={{
          background: `radial-gradient(ellipse at center,
            ${colors.primary}${Math.round((0.1 + Math.sin(frame * 0.05) * 0.05) * 255).toString(16).padStart(2, '0')} 0%,
            transparent 60%
          )`,
          pointerEvents: "none",
        }}
      />
    </AbsoluteFill>
  );
};

export default TitleCard;
